from selenium.webdriver.support import expected_conditions as ec
from selenium.webdriver.support.ui import WebDriverWait
from selenium.webdriver.chrome.options import Options
from selenium.webdriver.common.keys import Keys
from selenium.webdriver.common.by import By

from selenium import webdriver

import chromedriver_binary

from datetime import datetime
import requests
import logging
import pickle
import os

log = logging.getLogger(__name__)

class CookieMonster:

    def __init__(self,  login, password, config, path, cookie, resolution,
                    debug):

        self.login = login
        self.password = password
        self.config = config
        self.path = path
        self.cookie = cookie
        self.session = requests.Session()
        self.resolution = resolution
        self.debug = debug
        self.debug_url = path / 'debug/urls_debug'
        self.debug_ss = path / 'debug/screenshots'
        self.debug_cookie = path / '/debug/cookie_debug'

        self.agent = (  'Mozilla/5.0 (X11; Linux x86_64) \
                        AppleWebKit/537.36 (KHTML, like Gecko) \
                        Chrome/74.0.3729.108 Safari/537.36')
        self.header = { 'User-Agent': self.agent,
                        'Referer': self.config['header_referer']}

        self.session.headers.update(self.header)

        self.browser = None
        self.chrome_options = None

    def file_check(self):

        cookie = self.cookie

        try:
            if cookie.exists():
                cookie = cookie.as_posix()
                log.debug('Attempting to load cookie from file.')
                with open(cookie, mode='rb') as f:
                    self.session.cookies.update(pickle.load(f))
                return True
            else:
                log.warning('Cookie does not exist.')
        except Exception as e:
            log.debug('Cookie Check Failed - {}.'.format(e))
            # TODO: need to figure out the best way to add debug here.
        return False

    def validity_check(self):

        log.debug('Launching browser.')
        self.session.get(self.config['login_start'])

        # TODO: along with the key check, maybe check the cookie for expiry as well.
        log.debug('Validating cookie.')
        for key in self.session.cookies.get_dict(domain=self.config['domain']).keys():
            if key in ['1P_JAR', 'APISID', 'CONSENT', 'HSID', 'NID', 'SAPISID', 'SID', 'SIDCC', 'SSID']:
                # not sure if continue is the best method here.
                continue
            else:
                return False

        log.debug('Cookie exists and is valid.')
        return True

    def browser_init(self):

        try:
            log.debug('Setting up webdriver Chrome options.')
            self.chrome_options = Options()
            self.chrome_options.add_argument('--window-size={}'.format(self.resolution))
            self.chrome_options.add_argument('--no-sandbox')
            self.chrome_options.set_headless(headless=True)

            log.debug('Setting Chrome options.')
            self.browser = webdriver.Chrome(chrome_options=self.chrome_options)

            return True

        except Exception as e:
            log.error('Browser Init Failed - {}.'.format(e))
        return False

    def browser_login(self):

        # TODO: check if debug folder exists. create it if it doesn't. if folder
        # exists, clear previous contents so there's no debug redundency from
        # previous attempts.

        try:
            log.debug('Opening: {}'.format(self.config['login_start']))
            self.browser.get(self.config['login_start'])

            if self.debug:
                k = 'login_start'
                login = {'phase':'01_{}'.format(k), 'url':self.config[k]}
                self.debug_output(login=login)

            log.debug('Entering email...')
            email = self.browser.find_element_by_css_selector('[type=email]')
            email.send_keys(self.login)

            if self.debug:
                k = 'enter_email'
                login = {'phase':'02_{}'.format(k), 'url':self.browser.current_url}
                self.debug_output(login=login)

            log.debug('Submitting email...')
            email.send_keys(Keys.RETURN)

            if self.debug:
                k = 'submit_email'
                login = {'phase':'03_{}'.format(k), 'url':self.browser.current_url}
                self.debug_output(login=login)

            log.debug('Entering password...')
            password = self.browser.find_element_by_css_selector('[type=password]')
            password.send_keys(self.password)

            if self.debug:
                k = 'enter_password'
                login = {'phase':'04_{}'.format(k), 'url':self.browser.current_url}
                self.debug_output(login=login)

            log.debug('Submitting password...')
            password.send_keys(Keys.RETURN)

            if self.debug:
                k = 'submit_password'
                login = {'phase':'05_{}'.format(k), 'url':self.browser.current_url}
                self.debug_output(login=login)

            # TODO: could create a login type tree here based on configuration options
            # passed in via configuration.yaml file (notification, authenticator, etc)
            log.info('Waiting for user to approve login via 2FA phone notification...')
            wait = WebDriverWait(self.browser, 15, poll_frequency=1)
            # TODO: the below should be correct for localities which use .com. if
            # this package gains traction, we can have users set their locality in
            # the configuration.yaml file which will translate that locality to the
            # appropriate dict URL which corresponds to the appropriate successful
            # login URL.
            wait.until(ec.url_to_be(self.config['login_success']))

            if self.debug:
                k = 'login_success'
                login = {'phase':'06_{}'.format(k), 'url':self.browser.current_url}
                self.debug_output(login=login)

            return True

        except Exception as e:
            log.error('Browser Login Failed - {}.'.format(e))
            return False

    def export_cookies(self):

        try:
            log.debug('Opening {} via requests'.format(self.config['login_start']))
            self.session.get(self.config['login_start'])

            log.debug('Passing selenium cookies to requests.')
            for cookie in self.browser.get_cookies():
                self.session.cookies.set( version=0,
                                    name=cookie['name'],
                                    value=cookie['value'],
                                    domain=cookie.get('domain', None),
                                    path=cookie.get('path', '/'),
                                    secure=cookie.get('secure', False),
                                    expires=cookie.get('expiry', None),
                                    discard=False)

            log.debug('Exporting CookieJar via pickle binary.')

            with open(self.cookie.as_posix(), mode='wb') as f:
                pickle.dump(self.session.cookies, f)
            self.browser.quit()

            return True

        except Exception as e:
            log.error('Cookie Export Failed - {}.'.format(e))

        return False

    def check(self):

        log.debug('Checking for cookie existence & validity.')

        if self.file_check() and self.validity_check():
            return True
        else:
            log.warning('Cookie not found or invalid. Generating.')
            log.info('Initializing Chrome WebDriver.')
            if self.browser_init():
                log.info('Logging into Google account.')
                if self.browser_login():
                    log.info('Exporting cookie.')
                    self.export_cookies()
                    return True
        return False

    def debug_output(self, cookie=False, login=False):
        '''
        Inputs: exception, function name, pertinent data
        Performs: output to debug location of various types of inputs which
                  caused exceptions for troubleshooting.
        '''

        timestamp = datetime.now().strftime('%Y-%m-%d - %H:%M:%S')

        if cookie:
            pass
        elif login:

            if not self.debug_url.exists():
                log.debug('Creating url debug file.')
                self.debug_url.touch(mode=0o660)
            if not self.debug_ss.exists():
                log.debug('Creating screenshot folder.')
                self.debug_ss.mkdir(mode=0o770, parents=True)

            with open(self.debug_url, mode='a') as f:
                f.write('[{}][{}][{}]\n'
                    .format(timestamp, login['phase'], login['url']))

            self.browser.save_screenshot('{}/{}.png'
                                            .format(self.debug_ss.as_posix(),
                                                    login['phase']))
